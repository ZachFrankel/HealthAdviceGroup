<!-- HTML in templates/health.html -->
{% extends 'base.html' %}
{% block title %}Health Tracker Dashboard{% endblock %}

{% block content %}
{% set user = get_user_info() %}
<div class="container py-5">
  <div class="row g-4">
    <div class="col-lg-8">
      <div class="row g-4 mb-4">
        <div class="col-md-6">
          <div class="card shadow-sm">
            <div class="card-header bg-white">
              <h5 class="mb-0" style="color: #3DA18C;">User Details</h5>
            </div>
            <div class="card-body">
              <p><strong>Age:</strong> <span data-user-age>{{ user.age if user.age != None else 'Not provided' }}</span></p>
              <p><strong>Weight:</strong> <span data-user-weight>{{ (user.weight|string + ' kg') if user.weight != None else 'Not provided' }}</span></p>
              <p><strong>Height:</strong> <span data-user-height>{{ (user.height|string + ' cm') if user.height != None else 'Not provided' }}</span></p>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card shadow-sm">
            <div class="card-header bg-white">
              <h5 class="mb-0" style="color: #3DA18C;">Overall Health Score</h5>
            </div>
            <div class="card-body text-center">
              <div id="health-score-display">
                <div class="spinner-border spinner-border-sm text-secondary me-2" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
                Generating health score...
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-white">
          <h5 class="mb-0" style="color: #3DA18C;">Health Trends</h5>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <label class="form-label me-2">Show:</label>
            <div class="form-check form-check-inline">
                <input class="form-check-input filter-option" type="radio" name="dataFilter" id="filterWeight" value="weight" checked>
                <label class="form-check-label" for="filterWeight">Weight Trend</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input filter-option" type="radio" name="dataFilter" id="filterBP" value="bp">
                <label class="form-check-label" for="filterBP">Blood Pressure Trend</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input filter-option" type="radio" name="dataFilter" id="filterHR" value="hr">
                <label class="form-check-label" for="filterHR">Heart Rate Trend</label>
            </div>
        </div>
          <canvas id="healthTrendsChart"></canvas>
        </div>
      </div>
      
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-white">
          <h5 class="mb-0" style="color: #3DA18C;">Update Your Details</h5>
        </div>
        <div class="card-body">
          <form method="POST" action="{{ url_for('update_user_details') }}">
            <div class="mb-3">
                <label for="update_age" class="form-label">Age</label>
                <input type="number" class="form-control" id="update_age" name="age" placeholder="Enter your age" value="{{ user.age if user.age != None }}">
            </div>
            <div class="mb-3">
                <label for="update_weight" class="form-label">Weight (kg)</label>
                <input type="number" step="0.1" class="form-control" id="update_weight" name="weight" placeholder="Enter your weight" value="{{ user.weight if user.weight != None }}">
            </div>
            <div class="mb-3">
                <label for="update_height" class="form-label">Height (cm)</label>
                <input type="number" class="form-control" id="update_height" name="height" placeholder="Enter your height" value="{{ user.height if user.height != None }}">
            </div>
            <button type="submit" class="btn text-white w-100" style="background-color: #3DA18C;">Update Details</button>
        </form>
        </div>
      </div>
    </div>
    
    <div class="col-lg-4">
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-white">
          <h5 class="mb-0" style="color: #3DA18C;">Record Health Data</h5>
        </div>
        <div class="card-body">
          <form method="POST" action="{{ url_for('health') }}">
            <div class="mb-3">
              <label for="weight" class="form-label">Weight (kg)</label>
              <input type="number" step="0.1" class="form-control" id="weight" name="weight" placeholder="Enter your weight" required>
            </div>
            <div class="mb-3">
              <label for="blood_pressure" class="form-label">Blood Pressure (e.g., 120/80)</label>
              <input type="text" class="form-control" id="blood_pressure" name="blood_pressure" placeholder="Enter your blood pressure" required>
            </div>
            <div class="mb-3">
              <label for="heart_rate" class="form-label">Heart Rate (bpm)</label>
              <input type="number" class="form-control" id="heart_rate" name="heart_rate" placeholder="Enter your heart rate" required>
            </div>
            <div class="mb-3">
              <label for="notes" class="form-label">Notes (optional)</label>
              <textarea class="form-control" id="notes" name="notes" rows="3" placeholder="Any additional information"></textarea>
            </div>
            <button type="submit" class="btn text-white w-100" style="background-color: #3DA18C;">Submit</button>
          </form>
        </div>
      </div>
      
      <div class="card shadow-sm">
        <div class="card-header bg-white">
          <h5 class="mb-0" style="color: #3DA18C;">Past Health Entries</h5>
        </div>
        <div class="card-body">
          {% if metrics %}
            <div class="table-responsive">
              <table class="table table-striped table-hover mb-0">
                <thead class="table-light">
                  <tr>
                    <th>Date</th>
                    <th>Weight (kg)</th>
                    <th>BP</th>
                    <th>HR</th>
                    <th>Notes</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {% for metric in metrics %}
                  <tr>
                    <td>{{ metric.date.split()[0].split('-')|reverse|join('/') ~ ' ' ~ metric.date.split()[1] }}</td>
                    <td>{{ metric.weight }}</td>
                    <td>{{ metric.blood_pressure }}</td>
                    <td>{{ metric.heart_rate }}</td>
                    <td style="max-width: 200px;">
                      <div class="text-truncate" data-bs-toggle="tooltip" title="{{ metric.notes or '-' }}">
                          {{ metric.notes or '-' }}
                      </div>
                    </td>
                    <td>
                      <form method="POST" action="{{ url_for('remove_health_entry', entry_id=metric.id) }}" 
                            onsubmit="return confirm('Are you sure you want to remove this entry?');">
                        <button type="submit" class="btn btn-sm btn-danger">Remove</button>
                      </form>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <p class="text-center mb-0">No entries yet. Start tracking your health!</p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
      var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
      var tooltipList = tooltipTriggerList.map(function(tooltipTriggerEl) {
          return new bootstrap.Tooltip(tooltipTriggerEl)
      })
  });

  document.addEventListener('DOMContentLoaded', async function() {
    const metrics = {{ metrics|tojson|safe }};
    const scoreDisplay = document.getElementById('health-score-display');

    if (metrics && metrics.length > 0) {
        const prompt = `Given the following health metrics entries, calculate an overall health percentage score (100% being the highest). Provide ONLY a percentage number with % symbol, nothing else. Example correct response: "75%". Entries: ${metrics.map(m => 
            `Weight: ${m.weight} kg, Blood Pressure: ${m.blood_pressure}, Heart Rate: ${m.heart_rate}`
        ).join('; ')}`;

        try {
            const response = await fetch('/api/ai/generate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ prompt: prompt })
            });

            const data = await response.json();
            if (data.success) {
                const percentageMatch = data.response.match(/\d+(\.\d+)?%/);
                const healthScore = percentageMatch ? percentageMatch[0] : 'Error';
                
                scoreDisplay.innerHTML = `
                    <h2 class="display-4">${healthScore}</h2>
                    <p>Your overall wellness rating</p>
                `;
            } else {
                scoreDisplay.innerHTML = 'Error calculating health score';
            }
        } catch (error) {
            scoreDisplay.innerHTML = 'Error calculating health score';
            console.error('Error:', error);
        }
    } else {
        scoreDisplay.innerHTML = 'No health data available';
    }
  });

  document.addEventListener('DOMContentLoaded', function() {
      const updateForm = document.querySelector('form[action="{{ url_for("update_user_details") }}"]');
      const ageInput = document.getElementById('update_age');
      const weightInput = document.getElementById('update_weight');
      const heightInput = document.getElementById('update_height');
  
      updateForm.addEventListener('submit', async function(e) {
          e.preventDefault();
          
          try {
              const response = await fetch('{{ url_for("update_user_details") }}', {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/x-www-form-urlencoded',
                  },
                  body: new URLSearchParams({
                      'age': ageInput.value,
                      'weight': weightInput.value,
                      'height': heightInput.value
                  })
              });
  
              const result = await response.json();
              
              if (result.success) {
                  document.querySelector('[data-user-age]').textContent = result.user.age || 'Not provided';
                  document.querySelector('[data-user-weight]').textContent = result.user.weight ? `${result.user.weight} kg` : 'Not provided';
                  document.querySelector('[data-user-height]').textContent = result.user.height ? `${result.user.height} cm` : 'Not provided';
                  
                  const toastContainer = document.querySelector('.toast-container');
                  const toastHTML = `
                      <div class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
                          <div class="d-flex">
                              <div class="toast-body">
                                  Details updated successfully!
                              </div>
                              <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                          </div>
                      </div>
                  `;
                  toastContainer.insertAdjacentHTML('beforeend', toastHTML);
                  const toast = new bootstrap.Toast(toastContainer.lastElementChild);
                  toast.show();
              }
          } catch (error) {
              console.error('Error:', error);
          }
      });
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
      const rawMetrics = {{ metrics|tojson }};
      const labels = rawMetrics.map(entry => entry.date);
      const getWeightData = () => rawMetrics.map(entry => parseFloat(entry.weight));
      const getBPData = () => rawMetrics.map(entry => {
          if(entry.blood_pressure && entry.blood_pressure.includes('/')) {
              return parseFloat(entry.blood_pressure.split('/')[0]);
          }
          return null;
      });
      const getHRData = () => rawMetrics.map(entry => parseFloat(entry.heart_rate));
      
      const ctx = document.getElementById('healthTrendsChart').getContext('2d');
      let chart;
  
      function buildChart() {
          const selectedFilter = document.querySelector('input[name="dataFilter"]:checked').value;
          let dataset = {
              tension: 0.3,
              fill: true
          };
          
          switch(selectedFilter) {
              case 'weight':
                  dataset = {
                      ...dataset,
                      label: 'Weight (kg)',
                      data: getWeightData(),
                      borderColor: '#3DA18C',
                      backgroundColor: 'rgba(61, 161, 140, 0.2)'
                  };
                  break;
              case 'bp':
                  dataset = {
                      ...dataset,
                      label: 'Blood Pressure (Systolic)',
                      data: getBPData(),
                      borderColor: '#FF5733',
                      backgroundColor: 'rgba(255, 87, 51, 0.2)'
                  };
                  break;
              case 'hr':
                  dataset = {
                      ...dataset,
                      label: 'Heart Rate (bpm)',
                      data: getHRData(),
                      borderColor: '#4A90E2',
                      backgroundColor: 'rgba(74, 144, 226, 0.2)'
                  };
                  break;
          }
          
          if(chart) {
              chart.destroy();
          }
          
          chart = new Chart(ctx, {
              type: 'line',
              data: {
                  labels: labels,
                  datasets: [dataset]
              },
              options: {
                  responsive: true,
                  scales: {
                      x: {
                          display: true,
                          title: { display: true, text: 'Date' }
                      },
                      y: {
                          display: true,
                          beginAtZero: false
                      }
                  },
                  plugins: {
                      legend: { display: true }
                  }
              }
          });
      }
  
      buildChart();
  
      document.querySelectorAll('.filter-option').forEach(el => {
          el.addEventListener('change', buildChart);
      });
  });
</script>
{% endblock %}